


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > ChatWebSocketController</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.adnan.travner.controller</a>
</div>

<h1>Coverage Summary for Class: ChatWebSocketController (org.adnan.travner.controller)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ChatWebSocketController</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    11.1%
  </span>
  <span class="absValue">
    (1/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    1.7%
  </span>
  <span class="absValue">
    (1/60)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.adnan.travner.controller;
&nbsp;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.adnan.travner.dto.chat.ChatEventDTO;
&nbsp;import org.adnan.travner.dto.chat.SendMessageRequest;
&nbsp;import org.adnan.travner.dto.chat.TypingIndicatorRequest;
&nbsp;import org.adnan.travner.service.MessageService;
&nbsp;import org.adnan.travner.service.UserService;
&nbsp;import org.springframework.messaging.handler.annotation.DestinationVariable;
&nbsp;import org.springframework.messaging.handler.annotation.MessageMapping;
&nbsp;import org.springframework.messaging.handler.annotation.Payload;
&nbsp;import org.springframework.messaging.simp.SimpMessagingTemplate;
&nbsp;import org.springframework.messaging.simp.annotation.SubscribeMapping;
&nbsp;import org.springframework.stereotype.Controller;
&nbsp;
&nbsp;import java.security.Principal;
&nbsp;import java.time.Instant;
&nbsp;
&nbsp;/**
&nbsp; * WebSocket controller for real-time chat functionality
&nbsp; */
&nbsp;@Controller
&nbsp;@RequiredArgsConstructor
<b class="fc">&nbsp;@Slf4j</b>
&nbsp;public class ChatWebSocketController {
&nbsp;
&nbsp;        private final MessageService messageService;
&nbsp;        private final SimpMessagingTemplate messagingTemplate;
&nbsp;        private final UserService userService;
&nbsp;
&nbsp;        /**
&nbsp;         * Get display name for user (username or fallback to ID)
&nbsp;         */
&nbsp;        private String getUserDisplayName(String userId) {
&nbsp;                try {
<b class="nc">&nbsp;                        return userService.getByUsername(userId).getUserName();</b>
&nbsp;                } catch (Exception e) {
<b class="nc">&nbsp;                        log.warn(&quot;Could not fetch username for user: {}, using ID as fallback&quot;, userId);</b>
<b class="nc">&nbsp;                        return userId;</b>
&nbsp;                }
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Handle real-time message sending
&nbsp;         */
&nbsp;        @MessageMapping(&quot;/chat.sendMessage&quot;)
&nbsp;        public void sendMessage(@Payload SendMessageRequest request, Principal principal) {
<b class="nc">&nbsp;                log.debug(&quot;WebSocket message received from user: {} for conversation: {}&quot;,</b>
<b class="nc">&nbsp;                                principal.getName(), request.getConversationId());</b>
&nbsp;
&nbsp;                try {
&nbsp;                        // Send message through service
<b class="nc">&nbsp;                        var messageResponse = messageService.sendMessage(request, principal.getName());</b>
&nbsp;
&nbsp;                        // Create real-time event
<b class="nc">&nbsp;                        var event = ChatEventDTO.builder()</b>
<b class="nc">&nbsp;                                        .type(ChatEventDTO.EventType.MESSAGE_SENT)</b>
<b class="nc">&nbsp;                                        .conversationId(request.getConversationId())</b>
<b class="nc">&nbsp;                                        .userId(principal.getName())</b>
<b class="nc">&nbsp;                                        .userName(getUserDisplayName(principal.getName()))</b>
<b class="nc">&nbsp;                                        .data(messageResponse)</b>
<b class="nc">&nbsp;                                        .timestamp(Instant.now())</b>
<b class="nc">&nbsp;                                        .build();</b>
&nbsp;
&nbsp;                        // Broadcast to the conversation topic
<b class="nc">&nbsp;                        messagingTemplate.convertAndSend(</b>
<b class="nc">&nbsp;                                        &quot;/topic/conversation/&quot; + request.getConversationId(),</b>
&nbsp;                                        event);
&nbsp;
&nbsp;                } catch (Exception e) {
<b class="nc">&nbsp;                        log.error(&quot;Error sending message via WebSocket: {}&quot;, e.getMessage());</b>
<b class="nc">&nbsp;                        throw new RuntimeException(&quot;Failed to send message&quot;);</b>
&nbsp;                }
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Handle typing indicator
&nbsp;         */
&nbsp;        @MessageMapping(&quot;/chat.typing&quot;)
&nbsp;        public void handleTypingIndicator(@Payload TypingIndicatorRequest request, Principal principal) {
<b class="nc">&nbsp;                log.debug(&quot;Typing indicator from user: {} in conversation: {} - typing: {}&quot;,</b>
<b class="nc">&nbsp;                                principal.getName(), request.getConversationId(), request.isTyping());</b>
&nbsp;
<b class="nc">&nbsp;                ChatEventDTO.EventType eventType = request.isTyping() ? ChatEventDTO.EventType.USER_TYPING</b>
<b class="nc">&nbsp;                                : ChatEventDTO.EventType.USER_STOPPED_TYPING;</b>
&nbsp;
<b class="nc">&nbsp;                ChatEventDTO event = ChatEventDTO.builder()</b>
<b class="nc">&nbsp;                                .type(eventType)</b>
<b class="nc">&nbsp;                                .conversationId(request.getConversationId())</b>
<b class="nc">&nbsp;                                .userId(principal.getName())</b>
<b class="nc">&nbsp;                                .userName(getUserDisplayName(principal.getName()))</b>
<b class="nc">&nbsp;                                .timestamp(Instant.now())</b>
<b class="nc">&nbsp;                                .build();</b>
&nbsp;
&nbsp;                // Send to all users in the conversation except the sender
<b class="nc">&nbsp;                messagingTemplate.convertAndSend(</b>
<b class="nc">&nbsp;                                &quot;/topic/conversation/&quot; + request.getConversationId(),</b>
&nbsp;                                event);
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Handle user joining a conversation (subscribing to updates)
&nbsp;         */
&nbsp;        @SubscribeMapping(&quot;/topic/conversation/{conversationId}&quot;)
&nbsp;        public ChatEventDTO handleUserJoined(@DestinationVariable String conversationId, Principal principal) {
<b class="nc">&nbsp;                log.debug(&quot;User: {} joined conversation: {}&quot;, principal.getName(), conversationId);</b>
&nbsp;
<b class="nc">&nbsp;                ChatEventDTO event = ChatEventDTO.builder()</b>
<b class="nc">&nbsp;                                .type(ChatEventDTO.EventType.USER_JOINED_CONVERSATION)</b>
<b class="nc">&nbsp;                                .conversationId(conversationId)</b>
<b class="nc">&nbsp;                                .userId(principal.getName())</b>
<b class="nc">&nbsp;                                .userName(getUserDisplayName(principal.getName()))</b>
<b class="nc">&nbsp;                                .timestamp(Instant.now())</b>
<b class="nc">&nbsp;                                .build();</b>
&nbsp;
&nbsp;                // Notify other users about the join
<b class="nc">&nbsp;                messagingTemplate.convertAndSend(&quot;/topic/conversation/&quot; + conversationId, event);</b>
&nbsp;
<b class="nc">&nbsp;                return event;</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Handle user presence updates
&nbsp;         */
&nbsp;        @MessageMapping(&quot;/chat.presence&quot;)
&nbsp;        public void handlePresenceUpdate(@Payload ChatEventDTO presenceEvent, Principal principal) {
<b class="nc">&nbsp;                log.debug(&quot;Presence update from user: {} - status: {}&quot;, principal.getName(), presenceEvent.getType());</b>
&nbsp;
<b class="nc">&nbsp;                presenceEvent.setUserId(principal.getName());</b>
<b class="nc">&nbsp;                presenceEvent.setUserName(getUserDisplayName(principal.getName()));</b>
<b class="nc">&nbsp;                presenceEvent.setTimestamp(Instant.now());</b>
&nbsp;
&nbsp;                // Broadcast presence to all user&#39;s conversations
&nbsp;                // This could be optimized to only send to relevant conversations
<b class="nc">&nbsp;                messagingTemplate.convertAndSendToUser(</b>
<b class="nc">&nbsp;                                principal.getName(),</b>
&nbsp;                                &quot;/queue/presence&quot;,
&nbsp;                                presenceEvent);
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Handle message read events
&nbsp;         */
&nbsp;        @MessageMapping(&quot;/chat.messageRead&quot;)
&nbsp;        public void handleMessageRead(@Payload ChatEventDTO readEvent, Principal principal) {
<b class="nc">&nbsp;                log.debug(&quot;Message read event from user: {} in conversation: {}&quot;,</b>
<b class="nc">&nbsp;                                principal.getName(), readEvent.getConversationId());</b>
&nbsp;
<b class="nc">&nbsp;                readEvent.setUserId(principal.getName());</b>
<b class="nc">&nbsp;                readEvent.setUserName(getUserDisplayName(principal.getName()));</b>
<b class="nc">&nbsp;                readEvent.setTimestamp(Instant.now());</b>
<b class="nc">&nbsp;                readEvent.setType(ChatEventDTO.EventType.MESSAGE_READ);</b>
&nbsp;
&nbsp;                // Send read receipt to conversation
<b class="nc">&nbsp;                messagingTemplate.convertAndSend(</b>
<b class="nc">&nbsp;                                &quot;/topic/conversation/&quot; + readEvent.getConversationId(),</b>
&nbsp;                                readEvent);
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Send notification to specific user
&nbsp;         */
&nbsp;        public void sendUserNotification(String userId, ChatEventDTO event) {
<b class="nc">&nbsp;                log.debug(&quot;Sending notification to user: {} - type: {}&quot;, userId, event.getType());</b>
&nbsp;
<b class="nc">&nbsp;                messagingTemplate.convertAndSendToUser(</b>
&nbsp;                                userId,
&nbsp;                                &quot;/queue/notifications&quot;,
&nbsp;                                event);
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Send event to conversation participants
&nbsp;         */
&nbsp;        public void sendConversationEvent(String conversationId, ChatEventDTO event) {
<b class="nc">&nbsp;                log.debug(&quot;Sending event to conversation: {} - type: {}&quot;, conversationId, event.getType());</b>
&nbsp;
<b class="nc">&nbsp;                messagingTemplate.convertAndSend(</b>
&nbsp;                                &quot;/topic/conversation/&quot; + conversationId,
&nbsp;                                event);
&nbsp;        }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-10-08 15:15</div>
</div>
</body>
</html>
