


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > CartService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.adnan.travner.service</a>
</div>

<h1>Coverage Summary for Class: CartService (org.adnan.travner.service)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">CartService</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    11.1%
  </span>
  <span class="absValue">
    (1/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/28)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0.9%
  </span>
  <span class="absValue">
    (1/108)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.adnan.travner.service;
&nbsp;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.adnan.travner.dto.AddToCartRequest;
&nbsp;import org.adnan.travner.dto.CartDTO;
&nbsp;import org.adnan.travner.dto.ProductDTO;
&nbsp;import org.adnan.travner.dto.UpdateCartItemRequest;
&nbsp;import org.adnan.travner.entry.CartEntry;
&nbsp;import org.adnan.travner.entry.UserEntry;
&nbsp;import org.adnan.travner.repository.CartRepository;
&nbsp;import org.adnan.travner.repository.UserRepository;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.Optional;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;/**
&nbsp; * Service class for handling cart operations
&nbsp; */
&nbsp;@Service
&nbsp;@RequiredArgsConstructor
<b class="fc">&nbsp;@Slf4j</b>
&nbsp;public class CartService {
&nbsp;
&nbsp;    private final CartRepository cartRepository;
&nbsp;    private final UserRepository userRepository;
&nbsp;    private final ProductService productService;
&nbsp;
&nbsp;    /**
&nbsp;     * Get user&#39;s cart or create a new one if it doesn&#39;t exist
&nbsp;     */
&nbsp;    public CartDTO getUserCart(String username) {
<b class="nc">&nbsp;        log.debug(&quot;Getting cart for user: {}&quot;, username);</b>
&nbsp;
<b class="nc">&nbsp;        UserEntry user = userRepository.findByuserName(username);</b>
<b class="nc">&nbsp;        if (user == null) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;User not found: &quot; + username);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Optional&lt;CartEntry&gt; cartOpt = cartRepository.findByUserId(username); // Use username instead of ObjectId</b>
&nbsp;
&nbsp;        CartEntry cart;
<b class="nc">&nbsp;        if (cartOpt.isPresent()) {</b>
<b class="nc">&nbsp;            cart = cartOpt.get();</b>
&nbsp;        } else {
&nbsp;            // Create new cart for user
<b class="nc">&nbsp;            cart = CartEntry.builder()</b>
<b class="nc">&nbsp;                    .userId(username) // Use username instead of ObjectId</b>
<b class="nc">&nbsp;                    .build();</b>
<b class="nc">&nbsp;            cart = cartRepository.save(cart);</b>
<b class="nc">&nbsp;            log.debug(&quot;Created new cart for user: {}&quot;, username);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return convertToDTO(cart);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Add item to cart
&nbsp;     */
&nbsp;    @Transactional
&nbsp;    public CartDTO addToCart(String username, AddToCartRequest request) {
<b class="nc">&nbsp;        log.debug(&quot;Adding product {} to cart for user: {}&quot;, request.getProductId(), username);</b>
&nbsp;
<b class="nc">&nbsp;        UserEntry user = userRepository.findByuserName(username);</b>
<b class="nc">&nbsp;        if (user == null) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;User not found: &quot; + username);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Verify product exists and is available
<b class="nc">&nbsp;        ProductDTO product = productService.getProductById(request.getProductId())</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new RuntimeException(&quot;Product not found: &quot; + request.getProductId()));</b>
&nbsp;
<b class="nc">&nbsp;        if (!product.getIsAvailable()) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Product is not available for purchase&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Check if product has enough stock
<b class="nc">&nbsp;        if (product.getStockQuantity() != null &amp;&amp; product.getStockQuantity() &lt; request.getQuantity()) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Insufficient stock. Available: &quot; + product.getStockQuantity());</b>
&nbsp;        }
&nbsp;
&nbsp;        // Get or create cart using username
<b class="nc">&nbsp;        CartEntry cart = cartRepository.findByUserId(username)</b>
<b class="nc">&nbsp;                .orElse(CartEntry.builder()</b>
<b class="nc">&nbsp;                        .userId(username)</b>
<b class="nc">&nbsp;                        .build());</b>
&nbsp;
&nbsp;        // Create cart item
<b class="nc">&nbsp;        CartEntry.CartItem cartItem = CartEntry.CartItem.builder()</b>
<b class="nc">&nbsp;                .productId(product.getId())</b>
<b class="nc">&nbsp;                .productName(product.getName())</b>
<b class="nc">&nbsp;                .unitPrice(product.getPrice()) // This should work - both are BigDecimal</b>
<b class="nc">&nbsp;                .quantity(request.getQuantity())</b>
<b class="nc">&nbsp;                .sellerId(product.getSellerId())</b>
<b class="nc">&nbsp;                .sellerName(product.getSellerUsername())</b>
<b class="nc">&nbsp;                .productImage(product.getImages() != null &amp;&amp; !product.getImages().isEmpty() ? product.getImages().get(0) : null)</b>
<b class="nc">&nbsp;                .addedAt(LocalDateTime.now())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;
&nbsp;        // Calculate subtotal
<b class="nc">&nbsp;        cartItem.calculateSubtotal();</b>
&nbsp;
&nbsp;        // Add item to cart
<b class="nc">&nbsp;        cart.addItem(cartItem);</b>
&nbsp;
&nbsp;        // Save cart
<b class="nc">&nbsp;        cart = cartRepository.save(cart);</b>
&nbsp;
<b class="nc">&nbsp;        log.debug(&quot;Added {} units of product {} to cart for user: {}&quot;,</b>
<b class="nc">&nbsp;                request.getQuantity(), request.getProductId(), username);</b>
&nbsp;
<b class="nc">&nbsp;        return convertToDTO(cart);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Update cart item quantity
&nbsp;     */
&nbsp;    @Transactional
&nbsp;    public CartDTO updateCartItem(String username, UpdateCartItemRequest request) {
<b class="nc">&nbsp;        log.debug(&quot;Updating cart item {} quantity to {} for user: {}&quot;,</b>
<b class="nc">&nbsp;                request.getProductId(), request.getQuantity(), username);</b>
&nbsp;
<b class="nc">&nbsp;        UserEntry user = userRepository.findByuserName(username);</b>
<b class="nc">&nbsp;        if (user == null) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;User not found: &quot; + username);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        CartEntry cart = cartRepository.findByUserId(username)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new RuntimeException(&quot;Cart not found for user: &quot; + username));</b>
&nbsp;
&nbsp;        // Update item quantity
<b class="nc">&nbsp;        boolean updated = cart.updateItemQuantity(request.getProductId(), request.getQuantity());</b>
&nbsp;
<b class="nc">&nbsp;        if (!updated) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Product not found in cart: &quot; + request.getProductId());</b>
&nbsp;        }
&nbsp;
&nbsp;        // Save cart
<b class="nc">&nbsp;        cart = cartRepository.save(cart);</b>
&nbsp;
<b class="nc">&nbsp;        log.debug(&quot;Updated cart item {} quantity to {} for user: {}&quot;,</b>
<b class="nc">&nbsp;                request.getProductId(), request.getQuantity(), username);</b>
&nbsp;
<b class="nc">&nbsp;        return convertToDTO(cart);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Remove item from cart
&nbsp;     */
&nbsp;    @Transactional
&nbsp;    public CartDTO removeFromCart(String username, String productId) {
<b class="nc">&nbsp;        log.debug(&quot;Removing product {} from cart for user: {}&quot;, productId, username);</b>
&nbsp;
<b class="nc">&nbsp;        UserEntry user = userRepository.findByuserName(username);</b>
<b class="nc">&nbsp;        if (user == null) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;User not found: &quot; + username);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        CartEntry cart = cartRepository.findByUserId(username)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new RuntimeException(&quot;Cart not found for user: &quot; + username));</b>
&nbsp;
<b class="nc">&nbsp;        boolean removed = cart.removeItem(productId);</b>
&nbsp;
<b class="nc">&nbsp;        if (!removed) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Product not found in cart: &quot; + productId);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Save cart
<b class="nc">&nbsp;        cart = cartRepository.save(cart);</b>
&nbsp;
<b class="nc">&nbsp;        log.debug(&quot;Removed product {} from cart for user: {}&quot;, productId, username);</b>
&nbsp;
<b class="nc">&nbsp;        return convertToDTO(cart);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Clear entire cart
&nbsp;     */
&nbsp;    @Transactional
&nbsp;    public CartDTO clearCart(String username) {
<b class="nc">&nbsp;        log.debug(&quot;Clearing cart for user: {}&quot;, username);</b>
&nbsp;
<b class="nc">&nbsp;        UserEntry user = userRepository.findByuserName(username);</b>
<b class="nc">&nbsp;        if (user == null) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;User not found: &quot; + username);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        CartEntry cart = cartRepository.findByUserId(username)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new RuntimeException(&quot;Cart not found for user: &quot; + username));</b>
&nbsp;
<b class="nc">&nbsp;        cart.clearCart();</b>
&nbsp;
&nbsp;        // Save cart
<b class="nc">&nbsp;        cart = cartRepository.save(cart);</b>
&nbsp;
<b class="nc">&nbsp;        log.debug(&quot;Cleared cart for user: {}&quot;, username);</b>
&nbsp;
<b class="nc">&nbsp;        return convertToDTO(cart);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Get cart item count for user
&nbsp;     */
&nbsp;    public int getCartItemCount(String username) {
<b class="nc">&nbsp;        UserEntry user = userRepository.findByuserName(username);</b>
<b class="nc">&nbsp;        if (user == null) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;User not found: &quot; + username);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return cartRepository.findByUserId(username)</b>
<b class="nc">&nbsp;                .map(CartEntry::getTotalItems)</b>
<b class="nc">&nbsp;                .orElse(0);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Convert CartEntry to CartDTO
&nbsp;     */
&nbsp;    private CartDTO convertToDTO(CartEntry cart) {
<b class="nc">&nbsp;        return CartDTO.builder()</b>
<b class="nc">&nbsp;                .id(cart.getId())</b>
<b class="nc">&nbsp;                .userId(cart.getUserId())</b>
<b class="nc">&nbsp;                .items(cart.getItems().stream()</b>
<b class="nc">&nbsp;                        .map(this::convertItemToDTO)</b>
<b class="nc">&nbsp;                        .collect(Collectors.toList()))</b>
<b class="nc">&nbsp;                .totalAmount(cart.getTotalAmount())</b>
<b class="nc">&nbsp;                .totalItems(cart.getTotalItems())</b>
<b class="nc">&nbsp;                .createdAt(cart.getCreatedAt())</b>
<b class="nc">&nbsp;                .updatedAt(cart.getUpdatedAt())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Convert CartItem to CartItemDTO
&nbsp;     */
&nbsp;    private CartDTO.CartItemDTO convertItemToDTO(CartEntry.CartItem item) {
<b class="nc">&nbsp;        return CartDTO.CartItemDTO.builder()</b>
<b class="nc">&nbsp;                .productId(item.getProductId())</b>
<b class="nc">&nbsp;                .productName(item.getProductName())</b>
<b class="nc">&nbsp;                .unitPrice(item.getUnitPrice())</b>
<b class="nc">&nbsp;                .quantity(item.getQuantity())</b>
<b class="nc">&nbsp;                .subtotal(item.getSubtotal())</b>
<b class="nc">&nbsp;                .sellerId(item.getSellerId())</b>
<b class="nc">&nbsp;                .sellerName(item.getSellerName())</b>
<b class="nc">&nbsp;                .productImage(item.getProductImage())</b>
<b class="nc">&nbsp;                .addedAt(item.getAddedAt())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-10-09 15:10</div>
</div>
</body>
</html>
